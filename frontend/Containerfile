
FROM docker.io/library/node:18 AS builder
WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm install

# Copy source and build
COPY . .
RUN npm run build


# ================================
# Stage 2: Serve with Nginx (OpenShift friendly)
# ================================
FROM docker.io/library/nginx:alpine

# Clean default nginx html content
RUN rm -rf /usr/share/nginx/html/*

# Copy built app from builder
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy custom nginx config if you have one
COPY nginx.conf /etc/nginx/nginx.conf

# --- OpenShift compatibility ---
# OpenShift assigns a random non-root UID.  
# We ensure all required dirs are writable by group 0 (root group).  
RUN chgrp -R 0 /var/cache/nginx /var/run /var/log/nginx /etc/nginx /usr/share/nginx/html \
 && chmod -R g+rwX /var/cache/nginx /var/run /var/log/nginx /etc/nginx /usr/share/nginx/html \
 && touch /var/run/nginx.pid \
 && chgrp 0 /var/run/nginx.pid && chmod g+rw /var/run/nginx.pid

# Expose app port
EXPOSE 8080

# No USER set -> OpenShift will inject a random non-root UID automatically
CMD ["nginx", "-g", "daemon off;"]
